package page;

import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;
import org.testng.xml.Parser;
import org.testng.xml.XmlSuite;
import util.GMailService;

import java.io.IOException;
import java.util.Collection;

public class RequestPasswordResetPage extends BasePage {

  @FindBy(xpath = "//input[@name='userName']")
  private WebElement inputEmailOrPhoneField;

  @FindBy(xpath = "//button[@id='reset-password-submit-button']")
  private WebElement submitButton;

  public RequestPasswordResetPage(WebDriver driver) {
    this.driver = driver;
    PageFactory.initElements(driver, this);
  }

  public RequestPasswordResetSubmitPage findAccount(String userEmail) {
    inputEmailOrPhoneField.sendKeys(userEmail);
    String messageSubject = "the link to reset your password";
    String messageTo = userEmail;
    String messageFrom = "security-noreply@linkedin.com";
    GMailService gMailService = new GMailService();
    gMailService.connect();
    submitButton.click();
    String message = gMailService.waitMessage(messageSubject, messageTo, messageFrom, 180).replace("&amp;", "&");
    System.out.println("Content: " + message);

    Parser parser = new Parser("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"> <html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\" xml:lang=\"en\"> <head> <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\"> <meta name=\"HandheldFriendly\" content=\"true\"> <meta name=\"viewport\" content=\"width=device-width; initial-scale=0.666667; maximum-scale=0.666667; user-scalable=0\"> <meta name=\"viewport\" content=\"width=device-width\"> <title></title> <!--[if mso]><style type=\"text/css\">body {font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;}.phoenix-email-container {width: 512px !important;}</style><![endif]--> <!--[if IE]><style type=\"text/css\">.phoenix-email-container {width: 512px !important;}</style><![endif]--> <style type=\"text/css\">@media only screen and (max-width:32em) { .phoenix-email-container { width:100% !important; } } @media only screen and (max-width:20em) {} @media only screen and (max-device-width:30em) {} @media screen and (device-width:30em) and (device-height:22.5em), screen and (device-width:22.5em) and (device-height:30em), screen and (device-width:20em) and (device-height:15em) {} @media screen and (-webkit-min-device-pixel-ratio:0) {} @media screen and (max-device-width:25.88em) and (max-device-height:48.5em) {} </style> </head> <body style=\"padding:0;margin:0 auto;-webkit-text-size-adjust:100%;width:100% !important;-ms-text-size-adjust:100%;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;\"> <div style=\"overflow:hidden;color:transparent;visibility:hidden;mso-hide:all;width:0;font-size:0;opacity:0;height:0;\"> This link will expire in 24 hours </div> <table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" bgcolor=\"#EDF0F3\" style=\"background-color:#EDF0F3;table-layout:fixed;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <tbody> <tr> <td align=\"center\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <center style=\"width:100%;\"> <table border=\"0\" class=\"phoenix-email-container\" cellspacing=\"0\" cellpadding=\"0\" width=\"512\" bgcolor=\"#FFFFFF\" style=\"background-color:#FFFFFF;margin:0 auto;max-width:512px;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;width:inherit;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <tbody> <tr> <td bgcolor=\"#F6F8FA\" style=\"background-color:#F6F8FA;padding:12px;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;border-bottom:1px solid #ECECEC;\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;width:100% !important;mso-table-lspace:0pt;-ms-text-size-adjust:100%;min-width:100% !important;\"> <tbody> <tr> <td align=\"left\" valign=\"middle\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"><a href=\"https://www.linkedin.com/comm/feed/?midToken=AQGbi3NB1wMw0w&trk=eml-security_password_reset_checkpoint-header-1-home&trkEmail=eml-security_password_reset_checkpoint-header-1-home-null-c2ydvf%7Ejvwumiev%7Ez0-null-neptune%2Ffeed&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D\" style=\"cursor:pointer;color:#008CC9;-webkit-text-size-adjust:100%;display:inline-block;text-decoration:none;-ms-text-size-adjust:100%;\"> <img alt=\"LinkedIn\" border=\"0\" src=\"https://static.licdn.com/sc/p/com.linkedin.email-assets-frontend%3Aemail-assets-frontend-static-content%2B__latest__/f/%2Femail-assets-frontend%2Fimages%2Femail%2Fphoenix%2Flogos%2Flogo_phoenix_header_blue_78x66_v1.png\" height=\"34\" width=\"40\" style=\"outline:none;-ms-interpolation-mode:bicubic;color:#FFFFFF;text-decoration:none;\"></a></td> <td valign=\"middle\" width=\"100%\" align=\"right\" style=\"padding:0 0 0 10px;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"><a href=\"https://www.linkedin.com/comm/in/alex-tigrovich-4a37b4184?midToken=AQGbi3NB1wMw0w&trk=eml-security_password_reset_checkpoint-header-6-profile&trkEmail=eml-security_password_reset_checkpoint-header-6-profile-null-c2ydvf%7Ejvwumiev%7Ez0-null-neptune%2Fprofile%7Evanity%2Eview&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D\" style=\"cursor:pointer;margin:0;color:#008CC9;-webkit-text-size-adjust:100%;display:inline-block;text-decoration:none;-ms-text-size-adjust:100%;\"> <span style=\"word-wrap:break-word;color:#4C4C4C;word-break:break-word;font-weight:400;-ms-word-break:break-all;font-size:14px;line-height:1.429;overflow-wrap:break-word;\">Alex Tigrovich</span></a></td> <td valign=\"middle\" width=\"40\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;padding-left:10px;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <a href=\"https://www.linkedin.com/comm/in/alex-tigrovich-4a37b4184?midToken=AQGbi3NB1wMw0w&trk=eml-security_password_reset_checkpoint-header-6-profile&trkEmail=eml-security_password_reset_checkpoint-header-6-profile-null-c2ydvf%7Ejvwumiev%7Ez0-null-neptune%2Fprofile%7Evanity%2Eview&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D\" style=\"border-radius:50%;cursor:pointer;color:#008CC9;-webkit-text-size-adjust:100%;display:inline-block;text-decoration:none;-ms-text-size-adjust:100%;\"><img alt=\"\" border=\"0\" height=\"36\" width=\"36\" src=\"https://media.licdn.com/dms/image/C4E03AQEt2O_OI2XvcA/profile-displayphoto-shrink_100_100/0?e=2159024400&v=beta&t=44Izc-ptEWbinXNW3pnE9h0rudFddV2lPbSPChXkEFA\" style=\"border-radius:50%;outline:none;-ms-interpolation-mode:bicubic;color:#FFFFFF;text-decoration:none;\"></a></td> <td width=\"1\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\">&nbsp;</td> </tr> </tbody> </table></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <tbody> <tr> <td style=\"padding:20px 24px 32px 24px;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <tbody> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <h2 style=\"margin:0;color:#262626;font-weight:700;font-size:20px;line-height:1.2;\">Hi Alex,</h2></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\">Reset your password, and we'll get you on your way.</p></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\">To change your LinkedIn password, click the link below.</p></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\"><a href=\"https://www.linkedin.com/e/v2?e=c2ydvf-jvwumiev-z0&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D&a=checkpoint-password-reset&midToken=AQGbi3NB1wMw0w&tracking=eml-jav-saved-job&ek=security_password_reset_checkpoint&encryptedEmail=AgE6xKxgFdj9vwAAAWrXBxSgPffDaf1XVuUfXsIa1QQJCvbPEFrYuTez39ygQw_nUfL1yP2sghX3sUM&requestSubmissionId=AgECfhSSv3SydQAAAWrXBxSsgaF92X9U1tnqN6cyYwkXMa_3V_OjfHdm-DRhYsO2-Jff6AxKa7mjRCOI3ji0r_gX6AfD0kMMM_oSJ-MlRVs&oneTimeToken=-5688571345171829914&_sig=0N3z2l_UBDkoM1\" style=\"cursor:pointer;color:#008CC9;-webkit-text-size-adjust:100%;display:inline-block;text-decoration:none;-ms-text-size-adjust:100%;\">Reset my password</a></p></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\">This link will expire in 24 hours, so be sure to use it right away.</p></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;padding-bottom:20px;\"> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\">Thank you for using LinkedIn!</p> <p style=\"margin:0;color:#4C4C4C;font-weight:400;font-size:16px;line-height:1.25;\">The LinkedIn Team</p></td> </tr> </tbody> </table></td> </tr> </tbody> </table></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" bgcolor=\"#EDF0F3\" align=\"center\" style=\"background-color:#EDF0F3;padding:0 24px;color:#6A6C6D;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"> <tbody> <tr> <td align=\"center\" style=\"padding:16px 0 0 0;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"></td> </tr> <tr> <td style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;\"> <tbody> <tr> <td align=\"center\" style=\"padding:0 0 12px 0;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"> <p style=\"margin:0;color:#6A6C6D;font-weight:400;font-size:12px;line-height:1.333;\"></p></td> </tr> <tr> <td align=\"center\" style=\"padding:0 0 12px 0;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"> <p style=\"margin:0;word-wrap:break-word;color:#6A6C6D;word-break:break-word;font-weight:400;-ms-word-break:break-all;font-size:12px;line-height:1.333;overflow-wrap:break-word;\">This email was intended for Alex Tigrovich (Software Test Engineer at Ciklum). <a href=\"https://www.linkedin.com/e/v2?e=c2ydvf-jvwumiev-z0&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D&a=customerServiceUrl&midToken=AQGbi3NB1wMw0w&ek=security_password_reset_checkpoint&articleId=4788\" style=\"cursor:pointer;color:#6A6C6D;-webkit-text-size-adjust:100%;text-decoration:underline;display:inline-block;-ms-text-size-adjust:100%;\">Learn why we included this.</a></p></td> </tr> <tr> <td align=\"center\" style=\"padding:0 0 8px 0;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"><a href=\"https://www.linkedin.com/comm/feed/?midToken=AQGbi3NB1wMw0w&trk=eml-security_password_reset_checkpoint-footer-3-home&trkEmail=eml-security_password_reset_checkpoint-footer-3-home-null-c2ydvf%7Ejvwumiev%7Ez0-null-neptune%2Ffeed&lipi=urn%3Ali%3Apage%3Aemail_security_password_reset_checkpoint%3B22cQiUFCQROpMIzLIP%2FXkQ%3D%3D\" style=\"cursor:pointer;color:#6A6C6D;-webkit-text-size-adjust:100%;text-decoration:underline;display:inline-block;-ms-text-size-adjust:100%;\"><img alt=\"LinkedIn\" border=\"0\" height=\"14\" src=\"https://static.licdn.com/sc/p/com.linkedin.email-assets-frontend%3Aemail-assets-frontend-static-content%2B__latest__/f/%2Femail-assets-frontend%2Fimages%2Femail%2Fphoenix%2Flogos%2Flogo_phoenix_footer_darkgray_197x48_v1.png\" width=\"58\" style=\"outline:none;-ms-interpolation-mode:bicubic;color:#FFFFFF;display:block;text-decoration:none;\"></a></td> </tr> <tr> <td align=\"center\" style=\"padding:0 0 12px 0;-webkit-text-size-adjust:100%;mso-table-rspace:0pt;mso-table-lspace:0pt;-ms-text-size-adjust:100%;text-align:center;\"> <p style=\"margin:0;color:#6A6C6D;font-weight:400;font-size:12px;line-height:1.333;\">© 2019 LinkedIn Ireland Unlimited Company, Wilton Plaza, Wilton Place, Dublin 2. LinkedIn is a registered business name of LinkedIn Ireland Unlimited Company. LinkedIn and the LinkedIn logo are registered trademarks of LinkedIn.</p></td> </tr> </tbody> </table></td> </tr> </tbody> </table></td> </tr> </tbody> </table> </center></td> </tr> </tbody> </table> <img src=\"https://www.linkedin.com/emimp/ip_WXpKNVpIWm1MV3AyZDNWdGFXVjJMWG93OmMyVmpkWEpwZEhsZmNHRnpjM2R2Y21SZmNtVnpaWFJmWTJobFkydHdiMmx1ZEE9PTo=.gif\" style=\"outline:none;-ms-interpolation-mode:bicubic;color:#FFFFFF;text-decoration:none;width:1px;height:1px;\"> </body> </html>");
    Collection<XmlSuite> suites = null;
    try {
      suites = parser.parse();
    } catch (IOException e) {
      e.printStackTrace();
    }
    for (XmlSuite suite : suites) {
      System.out.println(suite.getParameter("href"));
    }

//    int indexOf = message.lastIndexOf("5;\"><a href=\"");
//    int lastIndexOf = message.lastIndexOf("\" style=\"");
//    messageResetURL = message.substring(indexOf + 13, lastIndexOf);
//    System.out.println("Reset URL: " + messageResetURL);

    return new RequestPasswordResetSubmitPage(driver);
  }

  public boolean isPageLoaded() {
    return submitButton.isDisplayed();
  }
}
